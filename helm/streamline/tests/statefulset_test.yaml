suite: Streamline core resources
templates:
  - statefulset.yaml
  - service.yaml
  - pdb.yaml
  - hpa.yaml
tests:
  - it: should create a StatefulSet with correct name
    template: statefulset.yaml
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-streamline

  - it: should create a Service with correct ports
    template: service.yaml
    documentIndex: 1
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-streamline
      - contains:
          path: spec.ports
          content:
            name: kafka
            port: 9092
            targetPort: kafka
      - contains:
          path: spec.ports
          content:
            name: http
            port: 9094
            targetPort: http

  - it: should create a PDB when enabled
    template: pdb.yaml
    set:
      podDisruptionBudget.enabled: true
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: metadata.name
          value: RELEASE-NAME-streamline
      - equal:
          path: spec.minAvailable
          value: 1

  - it: should not create a PDB when disabled
    template: pdb.yaml
    set:
      podDisruptionBudget.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create an HPA when autoscaling is enabled
    template: hpa.yaml
    set:
      autoscaling.enabled: true
      autoscaling.minReplicas: 1
      autoscaling.maxReplicas: 5
      autoscaling.targetCPUUtilizationPercentage: 75
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-streamline
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 5

  - it: should not create an HPA when autoscaling is disabled
    template: hpa.yaml
    set:
      autoscaling.enabled: false
    asserts:
      - hasDocuments:
          count: 0
