name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  lint-dockerfile:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

  lint-helm:
    name: Lint Helm Chart
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: azure/setup-helm@v4
      - name: Helm lint
        run: helm lint helm/streamline
      - name: Helm template (validate rendering)
        run: helm template test-release helm/streamline > /dev/null
      - name: Helm template with all options
        run: |
          helm template test-release helm/streamline \
            --set replicaCount=3 \
            --set persistence.enabled=true \
            --set metrics.enabled=true \
            > /dev/null

  test-helm:
    name: Helm Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-helm@v4
      - name: Install helm-unittest plugin
        run: helm plugin install https://github.com/helm-unittest/helm-unittest
      - name: Run Helm unit tests
        run: helm unittest helm/streamline/

  lint-k8s-manifests:
    name: Lint K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Validate YAML syntax
        run: |
          for f in k8s/*.yaml k8s/*.yml; do
            [ -f "$f" ] && python3 -c "import yaml; yaml.safe_load(open('$f'))" && echo "✅ $f" || echo "❌ $f"
          done

  lint-compose:
    name: Lint Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Validate compose files
        run: |
          for f in docker-compose*.yml; do
            docker compose -f "$f" config --quiet && echo "✅ $f" || echo "❌ $f"
          done
